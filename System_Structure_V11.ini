System_Structure_V1.1: Hệ thống Multi‑tenant AI Agent Cá nhân hóa
Phiên bản 1.1 – Chạy trên môi trường Local trước khi mở rộng

Tài liệu này mô tả chi tiết ý tưởng, yêu cầu, kiến trúc và lộ trình triển khai một hệ thống cho phép nhiều khách hàng (tenant) sở hữu một trợ lý AI riêng, có thể giao tiếp qua các nền tảng nhắn tin phổ biến (WhatsApp, Telegram, Discord…) với tính cách được cá nhân hóa sâu sắc. Hệ thống được xây dựng dựa trên nền tảng mã nguồn mở OpenClaw và sử dụng DeepSeek API làm động cơ AI chính. Phiên bản đầu tiên này tập trung vào việc chạy thành công trên môi trường local, làm cơ sở cho các bước mở rộng sau.

1. Ý tưởng (Idea)
Xây dựng một dịch vụ cho phép khách hàng (cá nhân, gia đình, nhóm nhỏ) có một AI Agent riêng, hoạt động như một thành viên trong gia đình hoặc người bạn đồng hành. Agent này:

Có thể trò chuyện qua các ứng dụng nhắn tin hàng ngày (WhatsApp, Telegram, Zalo, Discord…).

Sở hữu tính cách riêng do khách hàng định nghĩa (giọng nói, cách xưng hô, sở thích, ký ức gia đình…).

Có khả năng thực hiện các tác vụ tự động như nhắc nhở lịch sinh hoạt, gửi thông báo, tra cứu thông tin.

Đảm bảo riêng tư tuyệt đối: dữ liệu của mỗi khách hàng được cô lập hoàn toàn với nhau.

Về mặt kỹ thuật, mỗi khách hàng sẽ có một instance OpenClaw riêng chạy trong một container, với cấu hình và dữ liệu được lưu trữ độc lập. Một Control Plane tập trung sẽ quản lý vòng đời của các instance này và cung cấp giao diện cho khách hàng tự tùy chỉnh agent của mình.

2. Yêu cầu (Requirements)
2.1 Yêu cầu chức năng (Functional Requirements)
Mã	Chức năng	Mô tả
F1	Quản lý tenant	Tạo, xóa, liệt kê các tenant. Mỗi tenant có một định danh duy nhất.
F2	Cấu hình agent riêng	Tenant có thể tùy chỉnh tính cách (thông qua file SOUL.md), kiến thức nền (AGENTS.md), và danh sách kỹ năng (skills).
F3	Kết nối kênh giao tiếp	Tenant có thể tự kết nối agent của mình với các nền tảng nhắn tin (Telegram, WhatsApp, Zalo…).
F4	Nhắn tin hai chiều	Agent có thể nhận và trả lời tin nhắn từ người dùng trên các kênh đã kết nối.
F5	Tự động hóa	Hỗ trợ lên lịch các tác vụ định kỳ (cron) như nhắc nhở lịch sinh hoạt, gửi báo cáo.
F6	Ghi nhớ ngữ cảnh	Agent có thể nhớ thông tin trong suốt cuộc trò chuyện và gợi nhớ lại các sự kiện trong quá khứ (dài hạn).
F7	Giám sát & Logging	Ghi lại lịch sử trò chuyện, mức tiêu thụ token, trạng thái hệ thống.
2.2 Yêu cầu phi chức năng (Non‑functional Requirements)
Mã	Yêu cầu	Mô tả
N1	Cô lập dữ liệu	Dữ liệu của các tenant không được phép truy cập chéo.
N2	Khả năng mở rộng	Dễ dàng thêm tenant mới mà không ảnh hưởng đến tenant hiện tại.
N3	Hiệu năng	Thời gian phản hồi tin nhắn trung bình dưới 3 giây (với model API).
N4	Bảo mật	API keys, session channels được lưu trữ an toàn; giao tiếp qua HTTPS.
N5	Dễ triển khai	Có thể chạy toàn bộ hệ thống trên một máy local (Linux/macOS/Windows WSL2) để phát triển và thử nghiệm.
3. Kiến trúc tổng thể (Architecture Overview)
3.1 Mô hình container hóa cho mỗi tenant
Mỗi tenant sẽ vận hành trong một Docker container riêng, chạy một instance OpenClaw Gateway. Container này được gắn một volume chứa toàn bộ cấu hình và dữ liệu của tenant đó (~/.openclaw). Điều này đảm bảo cô lập tuyệt đối và dễ dàng quản lý tài nguyên.

3.2 Các thành phần chính
text
+----------------------------------------------------------------------------------+
|                             MÁY CHỦ (LOCAL HOẶC VPS)                              |
|                                                                                  |
|  +----------------------+    +----------------------+    +----------------------+ |
|  |   Tenant A Container |    |   Tenant B Container |    |   Tenant C Container | |
|  |  ------------------  |    |  ------------------  |    |  ------------------  | |
|  |  OpenClaw Gateway    |    |  OpenClaw Gateway    |    |  OpenClaw Gateway    | |
|  |  Port: 18790         |    |  Port: 18791         |    |  Port: 18792         | |
|  |  Volume: ./data/A    |    |  Volume: ./data/B    |    |  Volume: ./data/C    | |
|  +----------------------+    +----------------------+    +----------------------+ |
|                                                                                  |
|  +----------------------------------------------------------------------------+   |
|  |                     Control Plane (Node.js/Express)                        |   |
|  |  - Quản lý tenant (tạo/xóa container)                                      |   |
|  |  - Cung cấp REST API cho frontend                                          |   |
|  |  - Đọc/ghi file cấu hình trong volume tenant                               |   |
|  |  - Proxy WebSocket đến đúng container (nếu cần)                            |   |
|  +----------------------------------------------------------------------------+   |
|                                                                                  |
|  +----------------------------------------------------------------------------+   |
|  |                     Frontend Web (React/Next.js)                            |   |
|  |  - Trang đăng nhập                                                          |   |
|  |  - Dashboard tenant: xem & sửa SOUL.md, AGENTS.md                           |   |
|  |  - Hướng dẫn kết nối channel                                                |   |
|  |  - Xem lịch sử chat, thống kê                                               |   |
|  +----------------------------------------------------------------------------+   |
|                                                                                  |
|  +----------------------------------------------------------------------------+   |
|  |                     Cơ sở dữ liệu (MongoDB/PostgreSQL)                      |   |
|  |  - Lưu thông tin tenant (id, tên, container_id, port, ...)                  |   |
|  |  - Lưu metadata về tính cách (phiên bản, ngày chỉnh sửa)                    |   |
|  |  - (Tương lai) Lưu vector embeddings cho bộ nhớ dài hạn                     |   |
|  +----------------------------------------------------------------------------+   |
|                                                                                  |
+----------------------------------------------------------------------------------+
Luồng dữ liệu cơ bản:

Khách hàng truy cập web, đăng nhập, chỉnh sửa tính cách (lưu vào volume tenant).

Khách hàng kết nối Telegram/WhatsApp: làm theo hướng dẫn (lấy token, quét QR) – các bước này sẽ gọi API của Control Plane để cập nhật cấu hình channel trong container.

Người dùng cuối (thành viên gia đình) nhắn tin trên Telegram → Bot Telegram gửi request đến OpenClaw Gateway (thông qua webhook được cấu hình).

Gateway xử lý, gọi DeepSeek API (với prompt đã được cá nhân hóa từ SOUL.md), trả lời qua Telegram.

Control Plane ghi log và token usage vào database.

4. Các Phase triển khai (Implementation Phases)
Phase 1: Local MVP – Một tenant chạy thủ công
Mục tiêu: Có một agent hoạt động trên local, có thể trò chuyện qua Telegram, với tính cách được định nghĩa bằng file SOUL.md. Dùng DeepSeek API.

Các bước thực hiện
Cài đặt môi trường local

Ubuntu 22.04 / macOS / Windows WSL2.

Cài Node.js ≥ 22, Docker, Git.

Đăng ký DeepSeek API, lấy key.

Cài đặt OpenClaw

bash
npm install -g openclaw@latest
openclaw onboard --install-daemon   # Chạy wizard để tạo cấu hình mẫu
Cấu hình DeepSeek

Sửa file ~/.openclaw/openclaw.json:

json
{
  "agent": {
    "model": "deepseek/deepseek-chat"
  },
  "models": {
    "deepseek": {
      "apiKey": "sk-..."
    }
  }
}
Cấu hình Telegram Bot

Tạo bot qua @BotFather, lấy token.

Thêm channel telegram vào cấu hình:

json
"channels": {
  "telegram": {
    "enabled": true,
    "botToken": "TOKEN",
    "dmPolicy": "open"
  }
}
Tùy chỉnh tính cách

Tạo file ~/.openclaw/workspace/SOUL.md với nội dung mẫu (ví dụ “Người bà”).

(Tùy chọn) Tạo AGENTS.md chứa thông tin gia đình.

Chạy thử

bash
openclaw gateway restart
Nhắn tin cho bot Telegram, kiểm tra phản hồi.

Thêm cron job nhắc nhở (thủ công)

bash
openclaw cron add "0 7 * * 1-5" "openclaw message send --to @username --message 'Chào buổi sáng! Đi học nào!' --channel telegram"
Kết quả Phase 1: Một agent hoạt động tốt trên local, có thể giao tiếp qua Telegram, tính cách cơ bản.

Phase 2: Xây dựng Control Plane cơ bản & Multi‑tenant
Mục tiêu: Cho phép tạo nhiều tenant, mỗi tenant trong một container riêng. Xây dựng API quản lý và frontend đơn giản để tenant tự chỉnh sửa tính cách.

Các bước thực hiện
Thiết kế cấu trúc thư mục dữ liệu

text
/data/tenants/
  ├── tenant_1/
  │   └── .openclaw/          # Toàn bộ cấu hình của tenant 1
  ├── tenant_2/
  │   └── .openclaw/
  └── ...
Viết script khởi tạo tenant

Tạo thư mục tenant, copy file openclaw.json mẫu (với DeepSeek key dùng chung).

Tạo file SOUL.md và AGENTS.md mặc định.

Chạy container Docker với lệnh:

bash
docker run -d \
  --name openclaw-tenant-1 \
  -v /data/tenants/tenant_1/.openclaw:/root/.openclaw \
  -p 18790:18789 \
  node:22 \
  sh -c "npm install -g openclaw@latest && openclaw gateway"
Lưu tenant ID, port, container ID vào database.

Xây dựng Control Plane API (Node.js/Express)

Endpoint POST /tenants – tạo tenant mới (gọi script trên).

Endpoint GET /tenants/:id/config – lấy nội dung file SOUL.md.

Endpoint PUT /tenants/:id/config/soul – cập nhật SOUL.md.

Endpoint POST /tenants/:id/channels/telegram – cập nhật bot token (ghi vào openclaw.json và gửi signal restart container? Có thể dùng docker exec gửi lệnh openclaw channel add).

Xây dựng Frontend cơ bản (React)

Trang đăng nhập (dùng mật khẩu tĩnh cho MVP).

Dashboard: hiển thị thông tin tenant.

Trình soạn thảo Markdown cho SOUL.md (dùng react-simplemde-editor hoặc Monaco).

Hướng dẫn kết nối Telegram (hiển thị token bot, QR code nếu hỗ trợ).

Cơ chế đồng bộ cấu hình

Khi tenant sửa SOUL.md, API ghi file vào volume.

Cần restart gateway để áp dụng? Hoặc OpenClaw có cơ chế reload config? (Trailing: openclaw gateway reload hoặc gửi signal SIGHUP). Tạm thời dùng docker exec gửi lệnh openclaw gateway restart trong container.

Kiểm tra multi‑tenant

Tạo 2 tenant với port khác nhau.

Kết nối mỗi tenant với một Telegram bot riêng.

Kiểm tra tính cách và dữ liệu hoàn toàn độc lập.

Kết quả Phase 2: Hệ thống có thể vận hành nhiều tenant trên cùng máy local, mỗi tenant có một agent riêng biệt. Khách hàng có thể chỉnh sửa tính cánh qua web.

Phase 3: Nâng cao – Tự động hóa channel, bộ nhớ dài hạn, giám sát
Mục tiêu: Hoàn thiện tính năng để sẵn sàng cho production nhỏ (vài chục tenant). Tích hợp thanh toán, nâng cao trải nghiệm.

Các bước thực hiện
Tự động hóa kết nối WhatsApp và Zalo

Nghiên cứu các thư viện: whatsapp-web.js cho WhatsApp, zaloa cho Zalo.

Xây dựng backend service sinh mã QR và hiển thị trên frontend để khách hàng quét.

Lưu session vào volume tenant.

Bộ nhớ dài hạn (Long‑term memory)

Tích hợp Vector Database (ChromaDB hoặc Qdrant chạy local).

Tạo tool memory_search cho agent: khi cần nhớ, agent sẽ gọi tool này với câu query, tool truy vấn vector DB và trả về các đoạn hội thoại liên quan.

Cấu hình để tự động lưu các tin nhắn quan trọng vào vector DB (có thể dùng cron hoặc lưu sau mỗi hội thoại).

Giám sát và logging tập trung

Thu thập logs từ tất cả container bằng fluentd hoặc logstash.

Gửi vào Elasticsearch và xem với Kibana (hoặc dùng Grafana Loki).

Theo dõi số lượng token tiêu thụ theo tenant.

Tích hợp thanh toán đơn giản

Dùng Stripe hoặc PayPal.

Gói tháng dựa trên số lượng tin nhắn hoặc flat fee.

API cập nhật trạng thái tenant (active/suspended).

Cải thiện frontend

Cho phép tạo nhiều agent trong một tenant? (Mỗi agent có tính cách riêng cho các mục đích khác nhau).

Thêm tính năng xem lịch sử trò chuyện.

Dashboard thống kê usage.

Đóng gói và triển khai dễ dàng

Viết docker-compose.yml cho toàn bộ hệ thống (Control Plane, DB, reverse proxy, các tenant containers…).

Tạo script setup.sh để tự động hóa cài đặt trên VPS.

Kết quả Phase 3: Hệ thống hoàn chỉnh, có thể triển khai cho khách hàng thực tế với khả năng mở rộng tốt.

5. Công nghệ đề xuất (Technology Stack)
Thành phần	Công nghệ	Lý do
Container runtime	Docker	Nhẹ, phổ biến, dễ quản lý.
Ngôn ngữ Control Plane	Node.js (Express)	Thống nhất với hệ sinh thái OpenClaw (JavaScript).
Frontend	React + Next.js	Tốt cho SEO (nếu cần), dễ phát triển.
Database	MongoDB	Linh hoạt với dữ liệu không cấu trúc.
Vector DB	ChromaDB	Chạy local, dễ tích hợp với Node.js.
Reverse proxy	Nginx hoặc Caddy	Xử lý SSL, phân phối request đến đúng tenant container.
Giám sát	Prometheus + Grafana	(Phase 3) Theo dõi tài nguyên.
Logging	ELK stack hoặc Loki	(Phase 3) Tập trung log.
CI/CD	GitHub Actions	Tự động build và test.
6. Hướng dẫn cài đặt local (tóm tắt – Phase 1 & 2)
Yêu cầu: Ubuntu 22.04 (hoặc WSL2), Node.js 22, Docker, Git.

bash
# 1. Clone repository control-plane (sau khi xây dựng)
git clone https://github.com/yourname/ai-tenant-control.git
cd ai-tenant-control

# 2. Cài đặt dependencies cho control plane
npm install

# 3. Tạo thư mục dữ liệu
mkdir -p data/tenants

# 4. Khởi tạo tenant đầu tiên (script mẫu)
node scripts/create-tenant.js --name "Gia đình An"

# 5. Chạy control plane
npm start

# 6. Truy cập frontend tại http://localhost:3000
#    (cần chạy frontend riêng: cd frontend && npm run dev)
Cấu hình mẫu cho tenant: Đã được script tạo tự động.

7. Kết luận và Lộ trình phát triển
Với System_Structure_V1.1, chúng ta đã vạch ra một lộ trình rõ ràng từ một agent đơn lẻ trên local đến một hệ thống multi‑tenant hoàn chỉnh. Việc chạy thành công Phase 1 và Phase 2 trên local là bước đệm quan trọng để kiểm chứng kiến trúc và tích lũy kinh nghiệm trước khi triển khai lên VPS cho khách hàng thật.

Các mốc tiếp theo:

Tháng 1: Hoàn thành Phase 1, chạy ổn định với 1 tenant.

Tháng 2: Xây dựng Control Plane cơ bản (Phase 2), có thể tạo tenant thứ hai.

Tháng 3: Phát triển tính năng tự động hóa channel và bộ nhớ dài hạn (Phase 3), bắt đầu thử nghiệm với khách hàng đầu tiên.

Tháng 4: Hoàn thiện, đóng gói và chuẩn bị ra mắt dịch vụ.

